<!DOCTYPE html>
<html>
<head>
    <title>Scan Barcode</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }

        #scanner {
            width: 100%;
            max-width: 500px;
            height: 350px;
            margin: auto;
        }

        #status {
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h2>Scan Product Barcode</h2>
<div id="scanner"></div>
<div id="status">Initializing camera...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>

let isProcessing = false;

document.addEventListener("DOMContentLoaded", function () {

    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector("#scanner"),
            constraints: {
                facingMode: "environment"
            }
        },
        decoder: {
            readers: ["ean_reader", "upc_reader"]
        }
    }, function (err) {
        if (err) {
            console.error(err);
            document.getElementById("status").innerText = "Camera error.";
            return;
        }

        document.getElementById("status").innerText = "Camera ready. Scan barcode.";
        Quagga.start();
    });

    Quagga.onDetected(async function (data) {

        if (isProcessing) return;
        isProcessing = true;

        const barcode = data.codeResult.code;
        console.log("Detected:", barcode);

        document.getElementById("status").innerText =
            "Fetching product from OpenFoodFacts...";

        try {

            const response = await fetch(
                `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`
            );

            const result = await response.json();

            console.log("API response:", result);

            if (result.status === 1) {

                // Store product
                localStorage.setItem(
                    "openFoodProduct",
                    JSON.stringify(result.product)
                );

                document.getElementById("status").innerText =
                    "Product found! Redirecting...";

                setTimeout(() => {
                    window.location.href = "product.html";
                }, 1000);

            } else {

                document.getElementById("status").innerText =
                    "Product not found. Try another barcode.";
                isProcessing = false;
            }

        } catch (error) {
            console.error(error);
            document.getElementById("status").innerText =
                "Error fetching product.";
            isProcessing = false;
        }

    });

});
</script>

</body>
</html>
